// Mathieu Jacomy @ Sciences Po MÃ©dialab & WebAtlas
// (requires sigma.js to be loaded)
sigma.forceatlas2=sigma.forceatlas2||{};sigma.forceatlas2.ForceAtlas2=function(b){sigma.classes.Cascade.call(this);var a=this;this.graph=b;this.p={linLogMode:false,outboundAttractionDistribution:false,adjustSizes:false,edgeWeightInfluence:0,scalingRatio:1,strongGravityMode:false,gravity:1,jitterTolerance:1,barnesHutOptimize:false,barnesHutTheta:1.2,speed:1,outboundAttCompensation:1,totalSwinging:0,totalEffectiveTraction:0,complexIntervals:500,simpleIntervals:1000};this.state={step:0,index:0};this.rootRegion;this.init=function(){a.state={step:0,index:0};a.graph.nodes.forEach(function(c){c.fa2={mass:1+c.degree,old_dx:0,old_dy:0,dx:0,dy:0}});return a};this.go=function(){while(a.atomicGo()){}};this.atomicGo=function(){var d=a.graph;var w=d.nodes;var g=d.edges;var f=a.p.complexIntervals;var q=a.p.simpleIntervals;switch(a.state.step){case 0:w.forEach(function(e){if(e.fa2){e.fa2.mass=1+e.degree;e.fa2.old_dx=e.fa2.dx;e.fa2.old_dy=e.fa2.dx;e.fa2.dx=0;e.fa2.dy=0}else{e.fa2={mass:1+e.degree,old_dx:0,old_dy:0,dx:0,dy:0}}});if(a.p.barnesHutOptimize){a.rootRegion=new sigma.forceatlas2.Region(w,0);a.rootRegion.buildSubRegions()}if(a.p.outboundAttractionDistribution){a.p.outboundAttCompensation=0;w.forEach(function(e){a.p.outboundAttCompensation+=e.fa2.mass});a.p.outboundAttCompensation/=w.length}a.state.step=1;a.state.index=0;return true;break;case 1:var k=a.ForceFactory.buildRepulsion(a.p.adjustSizes,a.p.scalingRatio);if(a.p.barnesHutOptimize){var c=a.rootRegion;var p=a.p.barnesHutTheta;var A=a.state.index;while(A<w.length&&A<a.state.index+f){var v=w[A++];if(v.fa2){c.applyForce(v,k,p)}}if(A==w.length){a.state.step=2;a.state.index=0}else{a.state.index=A}}else{var y=a.state.index;while(y<w.length&&y<a.state.index+f){var o=w[y++];if(o.fa2){w.forEach(function(e,i){if(i<y&&e.fa2){k.apply_nn(o,e)}})}}if(y==w.length){a.state.step=2;a.state.index=0}else{a.state.index=y}}return true;break;case 2:var l=(a.p.strongGravityMode)?(a.ForceFactory.getStrongGravity(a.p.scalingRatio)):(a.ForceFactory.buildRepulsion(a.p.adjustSizes,a.p.scalingRatio));var j=a.p.gravity,D=a.p.scalingRatio;var A=a.state.index;while(A<w.length&&A<a.state.index+q){var v=w[A++];if(v.fa2){l.apply_g(v,j/D)}}if(A==w.length){a.state.step=3;a.state.index=0}else{a.state.index=A}return true;break;case 3:var u=a.ForceFactory.buildAttraction(a.p.linLogMode,a.p.outboundAttractionDistribution,a.p.adjustSizes,1*((a.p.outboundAttractionDistribution)?(a.p.outboundAttCompensation):(1)));var A=a.state.index;if(a.p.edgeWeightInfluence==0){while(A<g.length&&A<a.state.index+f){var B=g[A++];u.apply_nn(B.source,B.target,1)}}else{if(a.p.edgeWeightInfluence==1){while(A<g.length&&A<a.state.index+f){var B=g[A++];u.apply_nn(B.source,B.target,B.weight||1)}}else{while(A<g.length&&A<a.state.index+f){var B=g[A++];u.apply_nn(B.source,B.target,Math.pow(B.weight||1,a.p.edgeWeightInfluence))}}}if(A==g.length){a.state.step=4;a.state.index=0}else{a.state.index=A}return true;break;case 4:var t=0;var E=0;w.forEach(function(F){var i=F.fixed||false;if(!i&&F.fa2){var e=Math.sqrt(Math.pow(F.fa2.old_dx-F.fa2.dx,2)+Math.pow(F.fa2.old_dy-F.fa2.dy,2));t+=F.fa2.mass*e;E+=F.fa2.mass*0.5*Math.sqrt(Math.pow(F.fa2.old_dx+F.fa2.dx,2)+Math.pow(F.fa2.old_dy+F.fa2.dy,2))}});a.p.totalSwinging=t;a.p.totalEffectiveTraction=E;var m=Math.pow(a.p.jitterTolerance,2)*a.p.totalEffectiveTraction/a.p.totalSwinging;var s=0.5;a.p.speed=a.p.speed+Math.min(m-a.p.speed,s*a.p.speed);w.forEach(function(e){e.old_x=+e.x;e.old_y=+e.y});a.state.step=5;return true;break;case 5:var A=a.state.index;if(a.p.adjustSizes){var z=a.p.speed;while(A<w.length&&A<a.state.index+q){var v=w[A++];var h=v.fixed||false;if(!h&&v.fa2){var x=Math.sqrt((v.fa2.old_dx-v.fa2.dx)*(v.fa2.old_dx-v.fa2.dx)+(v.fa2.old_dy-v.fa2.dy)*(v.fa2.old_dy-v.fa2.dy));var r=0.1*z/(1+z*Math.sqrt(x));var C=Math.sqrt(Math.pow(v.fa2.dx,2)+Math.pow(v.fa2.dy,2));r=Math.min(r*C,10)/C;v.x+=v.fa2.dx*r;v.y+=v.fa2.dy*r}}}else{var z=a.p.speed;while(A<w.length&&A<a.state.index+q){var v=w[A++];var h=v.fixed||false;if(!h&&v.fa2){var x=Math.sqrt((v.fa2.old_dx-v.fa2.dx)*(v.fa2.old_dx-v.fa2.dx)+(v.fa2.old_dy-v.fa2.dy)*(v.fa2.old_dy-v.fa2.dy));var r=z/(1+z*Math.sqrt(x));v.x+=v.fa2.dx*r;v.y+=v.fa2.dy*r}}}if(A==w.length){a.state.step=0;a.state.index=0;return false}else{a.state.index=A;return true}break;default:throw new Error("ForceAtlas2 - atomic state error");break}};this.end=function(){this.graph.nodes.forEach(function(c){c.fa2=null})};this.setAutoSettings=function(){var c=this.graph;if(c.nodes.length>=100){this.p.scalingRatio=2}else{this.p.scalingRatio=10}this.p.strongGravityMode=false;this.p.gravity=1;this.p.outboundAttractionDistribution=false;this.p.linLogMode=false;this.p.adjustSizes=false;this.p.edgeWeightInfluence=1;if(c.nodes.length>=50000){this.p.jitterTolerance=10}else{if(c.nodes.length>=5000){this.p.jitterTolerance=1}else{this.p.jitterTolerance=0.1}}if(c.nodes.length>=1000){this.p.barnesHutOptimize=true}else{this.p.barnesHutOptimize=false}this.p.barnesHutTheta=1.2;return this};this.ForceFactory={buildRepulsion:function(d,c){if(d){return new this.linRepulsion_antiCollision(c)}else{return new this.linRepulsion(c)}},getStrongGravity:function(c){return new this.strongGravity(c)},buildAttraction:function(f,e,d,g){if(d){if(f){if(e){return new this.logAttraction_degreeDistributed_antiCollision(g)}else{return new this.logAttraction_antiCollision(g)}}else{if(e){return new this.linAttraction_degreeDistributed_antiCollision(g)}else{return new this.linAttraction_antiCollision(g)}}}else{if(f){if(e){return new this.logAttraction_degreeDistributed(g)}else{return new this.logAttraction(g)}}else{if(e){return new this.linAttraction_massDistributed(g)}else{return new this.linAttraction(g)}}}},linRepulsion:function(d){this.coefficient=d;this.apply_nn=function(g,f){if(g.fa2&&f.fa2){var c=g.x-f.x;var h=g.y-f.y;var i=Math.sqrt(c*c+h*h);if(i>0){var e=this.coefficient*g.fa2.mass*f.fa2.mass/Math.pow(i,2);g.fa2.dx+=c*e;g.fa2.dy+=h*e;f.fa2.dx-=c*e;f.fa2.dy-=h*e}}};this.apply_nr=function(i,g){var c=i.x-g.config("massCenterX");var f=i.y-g.config("massCenterY");var h=Math.sqrt(c*c+f*f);if(h>0){var e=this.coefficient*i.fa2.mass*g.config("mass")/Math.pow(h,2);i.fa2.dx+=c*e;i.fa2.dy+=f*e}};this.apply_g=function(j,h){var c=j.x;var f=j.y;var i=Math.sqrt(c*c+f*f);if(i>0){var e=this.coefficient*j.fa2.mass*h/i;j.fa2.dx-=c*e;j.fa2.dy-=f*e}}},linRepulsion_antiCollision:function(d){this.coefficient=d;this.apply_nn=function(g,f){if(g.fa2&&f.fa2){var c=g.x-f.x;var h=g.y-f.y;var i=Math.sqrt(c*c+h*h)-g.size-f.size;if(i>0){var e=this.coefficient*g.fa2.mass*f.fa2.mass/Math.pow(i,2);g.fa2.dx+=c*e;g.fa2.dy+=h*e;f.fa2.dx-=c*e;f.fa2.dy-=h*e}else{if(i<0){var e=100*this.coefficient*g.fa2.mass*f.fa2.mass;g.fa2.dx+=c*e;g.fa2.dy+=h*e;f.fa2.dx-=c*e;f.fa2.dy-=h*e}}}};this.apply_nr=function(i,g){var c=i.fa2.x()-g.getMassCenterX();var f=i.fa2.y()-g.getMassCenterY();var h=Math.sqrt(c*c+f*f);if(h>0){var e=this.coefficient*i.fa2.mass*g.getMass()/Math.pow(h,2);i.fa2.dx+=c*e;i.fa2.dy+=f*e}else{if(h<0){var e=-this.coefficient*i.fa2.mass*g.getMass()/h;i.fa2.dx+=c*e;i.fa2.dy+=f*e}}};this.apply_g=function(j,h){var c=j.x;var f=j.y;var i=Math.sqrt(c*c+f*f);if(i>0){var e=this.coefficient*j.fa2.mass*h/i;j.fa2.dx-=c*e;j.fa2.dy-=f*e}}},strongGravity:function(d){this.coefficient=d;this.apply_nn=function(e,c){};this.apply_nr=function(e,c){};this.apply_g=function(j,h){var c=j.x;var f=j.y;var i=Math.sqrt(c*c+f*f);if(i>0){var e=this.coefficient*j.fa2.mass*h;j.fa2.dx-=c*e;j.fa2.dy-=f*e}}},linAttraction:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var f=-this.coefficient*j;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}},linAttraction_massDistributed:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var f=-this.coefficient*j/h.fa2.mass;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}},logAttraction:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j*Math.log(1+k)/k;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}},logAttraction_degreeDistributed:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j*Math.log(1+k)/k/h.fa2.mass;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}},linAttraction_antiCollision:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}},linAttraction_degreeDistributed_antiCollision:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j/h.fa2.mass;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}},logAttraction_antiCollision:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j*Math.log(1+k)/k;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}},logAttraction_degreeDistributed_antiCollision:function(d){this.coefficient=d;this.apply_nn=function(h,g,j){if(h.fa2&&g.fa2){var c=h.x-g.x;var i=h.y-g.y;var k=Math.sqrt(c*c+i*i);if(k>0){var f=-this.coefficient*j*Math.log(1+k)/k/h.fa2.mass;h.fa2.dx+=c*f;h.fa2.dy+=i*f;g.fa2.dx-=c*f;g.fa2.dy-=i*f}}}}}};sigma.forceatlas2.Region=function(a,b){sigma.classes.Cascade.call(this);this.depthLimit=20;this.size=0;this.nodes=a;this.subregions=[];this.depth=b;this.p={mass:0,massCenterX:0,massCenterY:0};this.updateMassAndGeometry()};sigma.forceatlas2.Region.prototype.updateMassAndGeometry=function(){if(this.nodes.length>1){var d=0;var b=0;var a=0;this.nodes.forEach(function(f){d+=f.fa2.mass;b+=f.x*f.fa2.mass;a+=f.y*f.fa2.mass});var e=b/d;massCenterY=a/d;var c;this.nodes.forEach(function(g){var f=Math.sqrt((g.x-e)*(g.x-e)+(g.y-massCenterY)*(g.y-massCenterY));c=Math.max(c||(2*f),2*f)});this.p.mass=d;this.p.massCenterX=e;this.p.massCenterY=massCenterY;this.size=c}};sigma.forceatlas2.Region.prototype.buildSubRegions=function(){if(this.nodes.length>1){var b=[];var g=[];var h=[];var e=this.p.massCenterX;var d=this.p.massCenterY;var c=this.depth+1;var j=this;this.nodes.forEach(function(m){var l=(m.x<e)?(b):(g);l.push(m)});var k=[],a=[],i=[],f=[];b.forEach(function(m){var l=(m.y<d)?(k):(a);l.push(m)});g.forEach(function(m){var l=(m.y<d)?(f):(i);l.push(m)});[k,a,i,f].filter(function(l){return l.length}).forEach(function(l){if(c<=j.depthLimit&&l.length<j.nodes.length){var m=new sigma.forceatlas2.Region(l,c);h.push(m)}else{l.forEach(function(q){var p=[q];var o=new sigma.forceatlas2.Region(p,c);h.push(o)})}});this.subregions=h;h.forEach(function(l){l.buildSubRegions()})}};sigma.forceatlas2.Region.prototype.applyForce=function(e,b,c){if(this.nodes.length<2){var a=this.nodes[0];b.apply_nn(e,a)}else{var d=Math.sqrt((e.x-this.p.massCenterX)*(e.x-this.p.massCenterX)+(e.y-this.p.massCenterY)*(e.y-this.p.massCenterY));if(d*c>this.size){b.apply_nr(e,this)}else{this.subregions.forEach(function(f){f.applyForce(e,b,c)})}}};sigma.publicPrototype.startForceAtlas2=function(){this.forceatlas2=new sigma.forceatlas2.ForceAtlas2(this._core.graph);this.forceatlas2.setAutoSettings();this.forceatlas2.init();this.addGenerator("forceatlas2",this.forceatlas2.atomicGo,function(){return true})};sigma.publicPrototype.stopForceAtlas2=function(){this.removeGenerator("forceatlas2")};